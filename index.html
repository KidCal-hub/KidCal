<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KidCal ‚Äì One Calendar for Every Kid‚Äôs To-Dos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="KidCal helps busy families stay ahead of school, sports, camp and activity deadlines by putting every kid-related date in one simple place."
  />

  <style>
    :root {
      --bg: #f7fafc;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --radius-lg: 14px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.07);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top left, #eff6ff, #f9fafb);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header.site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .logo-wrap {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .logo {
      font-weight: 800;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
    }

    .logo span {
      color: var(--accent);
    }

    .tagline-mini {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .prototype-pill {
      background: #f97316;
      color: white;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .prototype-pill span {
      font-size: 1.1rem;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 24px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .hero-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 24px 20px;
      margin-bottom: 20px;
    }

    .hero-title {
      font-size: 1.8rem;
      margin: 0 0 10px;
    }

    .hero-subtitle {
      margin: 0 0 10px;
      color: var(--text-muted);
      font-size: 0.98rem;
      line-height: 1.5;
    }

    .hero-highlight {
      font-weight: 600;
    }

    .hero-list {
      margin: 10px 0 10px;
      padding-left: 18px;
      color: var(--text-muted);
      font-size: 0.92rem;
    }

    .hero-list li {
      margin-bottom: 4px;
    }

    .hint-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .pill-hint {
      background: var(--accent-soft);
      border-radius: 999px;
      padding: 6px 10px;
      display: inline-block;
      margin-top: 4px;
    }

    .cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease,
        background-color 0.15s ease;
      font-weight: 500;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 10px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-main);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .city-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .city-input-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
    }

    .section-title {
      font-size: 1.1rem;
      margin: 0 0 4px;
    }

    .section-subtitle {
      margin: 0 0 12px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .section-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 14px;
      margin-bottom: 16px;
    }

    .label-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 3px 9px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #1d4ed8;
      margin-bottom: 8px;
    }

    .events-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .filter-row select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 0.85rem;
      background: #f9fafb;
    }

    .events-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 460px;
      overflow-y: auto;
    }

    .event-item {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 10px 10px;
      margin-bottom: 8px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) auto;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .event-item {
        grid-template-columns: 1fr;
      }
    }

    .event-main {
      font-size: 0.9rem;
    }

    .event-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .event-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .event-city {
      font-weight: 500;
    }

    .event-link a {
      font-size: 0.8rem;
      color: var(--accent);
      text-decoration: none;
    }

    .event-link a:hover {
      text-decoration: underline;
    }

    .event-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 6px;
    }

    .chip-type {
      font-size: 0.75rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .no-events {
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 6px 4px 2px;
    }

    .reminders-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .reminders-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      box-shadow: none;
      padding: 5px 10px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-ghost-danger {
      border-color: #fecaca;
      color: var(--danger);
    }

    .reminders-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
      max-height: 260px;
      overflow-y: auto;
    }

    .reminder-item {
      border-radius: 9px;
      border: 1px solid var(--border);
      padding: 8px 8px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .reminder-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .reminder-title {
      font-weight: 600;
    }

    .reminder-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .btn-icon-only {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .empty-state {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    footer {
      margin-top: 18px;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: left;
    }

    .disclaimer {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .pill-prototype {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fff7ed;
      color: #9a3412;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    ol.info-list {
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    ol.info-list li {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="site-header">
      <div class="logo-wrap">
        <div class="logo">KidCal<span>.</span></div>
        <div class="tagline-mini">Built for busy families</div>
      </div>
      <div class="prototype-pill">
        <span>‚ö†Ô∏è</span> San Luis Obispo County prototype
      </div>
    </header>

    <main>
      <!-- LEFT COLUMN: HERO + FINDER -->
      <section>
        <div class="hero-card">
          <h1 class="hero-title">KidCal: One Calendar for Every Kid‚Äôs To-Dos</h1>
          <p class="hero-subtitle">
            <span class="hero-highlight">
              All your child‚Äôs registrations, events & deadlines ‚Äî organized in one place so you never miss a moment.
            </span>
            <br /><br />
            Enter your city or ZIP to instantly see enrollment dates, sports sign-ups, camps, school events, and more.
            Tap ‚ÄúAdd to my reminders‚Äù to build your do-not-miss list and download it to your calendar.
          </p>

          <ul class="hero-list">
            <li>School enrollment & key school dates</li>
            <li>Youth sports leagues & teams</li>
            <li>Camps, classes & kids‚Äô activities</li>
          </ul>

          <div class="pill-hint">
            Try: ‚ÄúAtascadero‚Äù, ‚ÄúSan Luis Obispo‚Äù, ‚ÄúPaso Robles‚Äù, ‚ÄúNipomo‚Äù, ‚ÄúTempleton‚Äù‚Ä¶ ZIP codes work too.
          </div>

          <div class="city-input-row">
            <input
              id="cityInput"
              type="text"
              placeholder="Enter city or ZIP (San Luis Obispo County)"
              autocomplete="off"
            />
          </div>

          <div class="cta-row">
            <button class="btn btn-primary" id="btnFind">
              Find My Kids‚Äô Deadlines
            </button>
            <button class="btn btn-secondary" id="btnSample">
              ‚ú® Try sample list
            </button>
          </div>
        </div>

        <!-- Registration finder section -->
        <div class="section-card">
          <p class="section-title">Registration finder (prototype)</p>
          <p class="section-subtitle">
            Enter a San Luis Obispo County city or town above to filter the list. The live version will load real deadlines
            from local partners using the KidCal sheet.
          </p>

          <div class="label-chip">
            üîé Browsing events
          </div>

          <div class="events-header-row">
            <div>
              <strong>All school, sports & activity events</strong>
            </div>
            <div class="filter-row">
              <span>Filter by type:</span>
              <select id="typeFilter">
                <option value="all">All</option>
                <option value="school">School</option>
                <option value="sports">Sports</option>
                <option value="camp">Camps & activities</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <p class="section-subtitle">
            Filter by type, then tap ‚ÄúAdd to my reminders‚Äù to build your do-not-miss list of registrations and key dates.
          </p>

          <ul id="eventsList" class="events-list"></ul>
          <p id="eventsEmpty" class="no-events" style="display: none;">
            No events match your filters yet. Try a different city, or tap ‚ÄúTry sample list‚Äù.
          </p>
        </div>
      </section>

      <!-- RIGHT COLUMN: REMINDERS + HOW-TO CARD -->
      <section>
        <div class="section-card">
          <p class="section-title">My reminder calendar</p>
          <p class="section-subtitle">
            Saved on this device. Download an .ics file to import into your own calendar (Google, Apple, Outlook and more).
          </p>

          <div class="reminders-header-row">
            <div class="label-chip">
              üìÖ Reminders
            </div>
            <div class="reminders-actions">
              <button class="btn-ghost btn-ghost-danger" id="btnClearReminders">
                Clear
              </button>
              <button class="btn-ghost" id="btnDownloadIcs">
                ‚¨áÔ∏è Download .ics
              </button>
            </div>
          </div>

          <ul id="remindersList" class="reminders-list"></ul>
          <p id="remindersEmpty" class="empty-state">
            No reminders yet. Add a school, sports, camp, or activity registration from the list to see it here.
          </p>
        </div>

        <!-- HOW TO ADD PROGRAM CARD -->
        <div class="section-card">
          <p class="section-title">How to add your program to KidCal</p>
          <p class="section-subtitle">
            Local schools, sports leagues, camps, and youth programs can add their dates into the shared KidCal sheet.
            Once added, they‚Äôll appear here for families to discover.
          </p>

          <ol class="info-list">
            <li>
              Open the shared KidCal programs sheet:
              <a
                href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSTGyzF9lGXW8a1--CtEYzaQFhZnkU0Ye8InlnVPgbmyYaiYzy8wPEgGp2dVodt-GEbonPHKGRKQJwl/pub?gid=0&single=true&output=csv"
                target="_blank"
                rel="noopener noreferrer"
              >
                KidCal programs sheet
              </a>.
            </li>
            <li>
              Add a new row with at least these columns filled in:
              <strong>City</strong>, <strong>Title</strong>, <strong>Type</strong> (school, sports, camp, or other),
              <strong>Date</strong>, <strong>Deadline label</strong>, <strong>Provider</strong>, and <strong>Link</strong>.
            </li>
            <li>
              Optional columns like <strong>Age range</strong>, <strong>Cost</strong>, or <strong>Notes</strong> are welcome.
              The website safely ignores extra columns, so adding more details will not break anything.
            </li>
            <li>
              Save your changes. Updates may take a few minutes to show up in KidCal as the sheet is synced.
            </li>
          </ol>
        </div>

        <footer>
          <div>
            KidCal helps parents stay organized by collecting local kids‚Äô activity deadlines in one place.
          </div>
          <div class="disclaimer">
            <span class="pill-prototype">
              Prototype only
            </span>
            <br />
            This version uses sample and sheet-based data to show how KidCal will work. Dates and offerings change each season.
            Always confirm through the linked district or recreation site before you rely on a deadline.
          </div>
        </footer>
      </section>
    </main>
  </div>

  <script>
    // --- Google Sheet CSV URL ---
    const SHEET_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSTGyzF9lGXW8a1--CtEYzaQFhZnkU0Ye8InlnVPgbmyYaiYzy8wPEgGp2dVodt-GEbonPHKGRKQJwl/pub?gid=0&single=true&output=csv";

    // --- Fallback sample events for SLO County prototype ---
    const SAMPLE_EVENTS = [
      {
        id: 1,
        city: "San Luis Obispo",
        type: "school",
        title: "Kindergarten registration opens",
        date: "2025-03-01",
        deadlineLabel: "Opens Mar 1, 2025",
        provider: "SLOUSD",
        link: "https://www.slcusd.org/"
      },
      {
        id: 2,
        city: "Atascadero",
        type: "sports",
        title: "Spring soccer league registration",
        date: "2025-02-10",
        deadlineLabel: "Register by Feb 10, 2025",
        provider: "Atascadero Recreation",
        link: "https://www.atascadero.org/"
      },
      {
        id: 3,
        city: "Paso Robles",
        type: "camp",
        title: "Summer day camp session 1",
        date: "2025-06-15",
        deadlineLabel: "Early bird ends May 15, 2025",
        provider: "Paso Robles Recreation Services",
        link: "https://www.prcity.com/"
      },
      {
        id: 4,
        city: "Nipomo",
        type: "sports",
        title: "Little League player registration",
        date: "2025-01-20",
        deadlineLabel: "Tryouts in late January",
        provider: "Nipomo Little League",
        link: "https://www.littleleague.org/"
      },
      {
        id: 5,
        city: "Templeton",
        type: "school",
        title: "Middle school back-to-school night",
        date: "2025-08-20",
        deadlineLabel: "Evening of Aug 20, 2025",
        provider: "Templeton Unified",
        link: "https://www.templetonusd.org/"
      },
      {
        id: 6,
        city: "San Luis Obispo",
        type: "other",
        title: "Library storytime sign-up",
        date: "2025-04-05",
        deadlineLabel: "Weekly sessions starting Apr 5, 2025",
        provider: "SLO County Libraries",
        link: "https://www.slolibrary.org/"
      }
    ];

    // This will be replaced by sheet data if available
    let EVENTS = [...SAMPLE_EVENTS];

    const cityInput = document.getElementById("cityInput");
    const typeFilter = document.getElementById("typeFilter");
    const eventsList = document.getElementById("eventsList");
    const eventsEmpty = document.getElementById("eventsEmpty");

    const btnFind = document.getElementById("btnFind");
    const btnSample = document.getElementById("btnSample");

    const remindersList = document.getElementById("remindersList");
    const remindersEmpty = document.getElementById("remindersEmpty");
    const btnClearReminders = document.getElementById("btnClearReminders");
    const btnDownloadIcs = document.getElementById("btnDownloadIcs");

    const STORAGE_KEY = "kidcal-reminders-v1";

    let currentEvents = [...EVENTS];
    let reminders = loadRemindersFromStorage();

    function loadRemindersFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.warn("Could not load reminders from storage", e);
        return [];
      }
    }

    function saveRemindersToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
      } catch (e) {
        console.warn("Could not save reminders", e);
      }
    }

    function renderEvents() {
      eventsList.innerHTML = "";
      const filterType = typeFilter.value;
      const list = currentEvents.filter((ev) => {
        if (filterType === "all") return true;
        return (ev.type || "other").toLowerCase() === filterType;
      });

      if (list.length === 0) {
        eventsEmpty.style.display = "block";
        return;
      }

      eventsEmpty.style.display = "none";

      list.forEach((ev) => {
        const li = document.createElement("li");
        li.className = "event-item";

        const main = document.createElement("div");
        main.className = "event-main";

        const title = document.createElement("div");
        title.className = "event-title";
        title.textContent = ev.title || "(No title)";

        const meta1 = document.createElement("div");
        meta1.className = "event-meta";
        meta1.innerHTML =
          '<span class="event-city">' +
          (ev.city || "Unknown city") +
          "</span>" +
          (ev.provider ? " ¬∑ " + ev.provider : "");

        const meta2 = document.createElement("div");
        meta2.className = "event-meta";
        meta2.textContent = ev.deadlineLabel || "";

        const link = document.createElement("div");
        link.className = "event-link";
        if (ev.link) {
          const a = document.createElement("a");
          a.href = ev.link;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Go to registration or info page ‚Üí";
          link.appendChild(a);
        }

        main.appendChild(title);
        main.appendChild(meta1);
        if (ev.deadlineLabel) main.appendChild(meta2);
        main.appendChild(link);

        const actions = document.createElement("div");
        actions.className = "event-actions";

        const typeChip = document.createElement("div");
        typeChip.className = "chip-type";
        typeChip.textContent = prettyType(ev.type);

        const btnAdd = document.createElement("button");
        btnAdd.className = "btn btn-secondary";
        btnAdd.style.padding = "5px 10px";
        btnAdd.style.fontSize = "0.8rem";
        btnAdd.textContent = "Add to my reminders";
        btnAdd.addEventListener("click", () => addReminder(ev));

        actions.appendChild(typeChip);
        actions.appendChild(btnAdd);

        li.appendChild(main);
        li.appendChild(actions);
        eventsList.appendChild(li);
      });
    }

    function prettyType(type) {
      const t = (type || "other").toLowerCase();
      switch (t) {
        case "school":
          return "School";
        case "sports":
          return "Sports";
        case "camp":
        case "camp/activity":
          return "Camp / Activity";
        case "other":
          return "Other";
        default:
          return t.charAt(0).toUpperCase() + t.slice(1);
      }
    }

    function renderReminders() {
      remindersList.innerHTML = "";
      if (!reminders.length) {
        remindersEmpty.style.display = "block";
        return;
      }
      remindersEmpty.style.display = "none";

      reminders.forEach((r, index) => {
        const li = document.createElement("li");
        li.className = "reminder-item";

        const main = document.createElement("div");
        main.className = "reminder-main";

        const title = document.createElement("div");
        title.className = "reminder-title";
        title.textContent = r.title || "(No title)";

        const meta = document.createElement("div");
        meta.className = "reminder-meta";
        const parts = [];
        if (r.deadlineLabel) parts.push(r.deadlineLabel);
        if (r.city) parts.push(r.city);
        if (r.provider) parts.push(r.provider);
        meta.textContent = parts.join(" ¬∑ ");

        main.appendChild(title);
        main.appendChild(meta);

        const btnRemove = document.createElement("button");
        btnRemove.className = "btn-icon-only";
        btnRemove.textContent = "‚úï";
        btnRemove.title = "Remove";
        btnRemove.addEventListener("click", () => {
          reminders.splice(index, 1);
          saveRemindersToStorage();
          renderReminders();
        });

        li.appendChild(main);
        li.appendChild(btnRemove);
        remindersList.appendChild(li);
      });
    }

    function addReminder(ev) {
      const exists = reminders.some((r) => r.id === ev.id);
      if (!exists) {
        reminders.push({
          id: ev.id,
          title: ev.title,
          city: ev.city,
          provider: ev.provider,
          deadlineLabel: ev.deadlineLabel,
          date: ev.date
        });
        saveRemindersToStorage();
        renderReminders();
      }
    }

    function handleFind() {
      const city = (cityInput.value || "").trim().toLowerCase();
      if (!city) {
        currentEvents = [...EVENTS];
        renderEvents();
        return;
      }
      currentEvents = EVENTS.filter(
        (ev) => (ev.city || "").toLowerCase().includes(city)
      );
      renderEvents();
    }

    function handleSample() {
      cityInput.value = "";
      currentEvents = [...EVENTS];
      renderEvents();
    }

    function clearReminders() {
      if (!reminders.length) return;
      if (!confirm("Clear all reminders saved on this device?")) return;
      reminders = [];
      saveRemindersToStorage();
      renderReminders();
    }

    function generateIcsContent() {
      if (!reminders.length) {
        alert("No reminders yet. Add at least one before downloading.");
        return null;
      }

      const lines = [];
      lines.push("BEGIN:VCALENDAR");
      lines.push("VERSION:2.0");
      lines.push("PRODID:-//KidCal//Prototype//EN");

      reminders.forEach((r, idx) => {
        const dt = (r.date || "").replace(/-/g, "");
        const start = dt || "20250101";

        lines.push("BEGIN:VEVENT");
        lines.push(`UID:kidcal-${r.id || idx}@kidcal`);
        lines.push(`SUMMARY:${escapeText(r.title || "")}`);
        lines.push(
          `DESCRIPTION:${escapeText(
            `${r.city || ""}${r.provider ? " ¬∑ " + r.provider : ""}${
              r.deadlineLabel ? " ¬∑ " + r.deadlineLabel : ""
            }`
          )}`
        );
        lines.push(`DTSTART;VALUE=DATE:${start}`);
        lines.push("END:VEVENT");
      });

      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function escapeText(text) {
      return String(text)
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;")
        .replace(/\n/g, "\\n");
    }

    function downloadIcs() {
      const content = generateIcsContent();
      if (!content) return;

      const blob = new Blob([content], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kidcal-reminders.ics";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Simple CSV parser (assumes no commas inside cells) ---
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return { headers: [], rows: [] };

      const headers = lines[0].split(",").map((h) => h.trim());
      const rows = lines.slice(1).map((line) => {
        const cells = line.split(",").map((c) => c.trim());
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = cells[i] || "";
        });
        return obj;
      });

      return { headers, rows };
    }

    // Helper to get a value from row by trying multiple header names
    function getCell(row, candidates) {
      for (const name of candidates) {
        for (const key of Object.keys(row)) {
          if (key.toLowerCase().trim() === name.toLowerCase().trim()) {
            return row[key] || "";
          }
        }
      }
      return "";
    }

    async function fetchSheetData() {
      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error("Network error");
        const text = await res.text();
        const parsed = parseCsv(text);

        if (!parsed.rows || !parsed.rows.length) {
          console.warn("Sheet has no rows; keeping sample events.");
          return;
        }

        const mapped = parsed.rows
          .map((row, idx) => {
            const title = getCell(row, ["title", "event_title", "name"]);
            if (!title) return null;

            const city = getCell(row, ["city", "town"]);
            const type = (
              getCell(row, ["type", "category"]) || "other"
            ).toLowerCase();
            const date = getCell(row, ["date", "start_date"]);
            const deadlineLabel = getCell(row, [
              "deadline_label",
              "deadline",
              "deadline text",
              "notes"
            ]);
            const provider = getCell(row, [
              "provider",
              "host",
              "organization",
              "org"
            ]);
            const link = getCell(row, ["link", "url", "website"]);

            return {
              id: "sheet-" + idx,
              city,
              type,
              title,
              date,
              deadlineLabel,
              provider,
              link
              // Extra columns like age_range, cost, etc. are safely ignored
            };
          })
          .filter(Boolean);

        if (mapped.length) {
          EVENTS = mapped;
          currentEvents = [...EVENTS];
          renderEvents();
          console.info(`Loaded ${mapped.length} events from sheet.`);
        }
      } catch (e) {
        console.warn("Failed to load sheet data; using sample events.", e);
        EVENTS = [...SAMPLE_EVENTS];
        currentEvents = [...EVENTS];
        renderEvents();
      }
    }

    // --- Event listeners ---
    btnFind.addEventListener("click", handleFind);
    btnSample.addEventListener("click", handleSample);
    typeFilter.addEventListener("change", renderEvents);
    btnClearReminders.addEventListener("click", clearReminders);
    btnDownloadIcs.addEventListener("click", downloadIcs);

    cityInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        handleFind();
      }
    });

    // Initial render: show whatever EVENTS currently is, then try to swap in sheet data
    handleSample();
    renderReminders();
    fetchSheetData();
  </script>
</body>
</html>
