<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KidCal ‚Äì SLO County kids signups in one place</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Search kid activities, enrollments, sports, camps, and family events across San Luis Obispo County. Save and export to your calendar." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1d4ed8">

  <style>
    :root{
      --blue:#1d4ed8; --blue2:#1e3a8a; --yellow:#facc15;
      --bg:#f7f9ff; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
      --r:16px; --shadow:0 10px 25px rgba(15,23,42,.12);
      --font: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;flex-direction:column;gap:4px}
    .logo{font-weight:900;font-size:1.7rem;letter-spacing:.02em;color:var(--blue2)}
    .logo span{color:var(--yellow)}
    .tag{color:var(--muted);font-size:.95rem}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#eaf0ff;border:1px solid #dbeafe;color:var(--blue2);padding:6px 10px;border-radius:999px;font-size:.85rem}
    main{display:grid;grid-template-columns:minmax(0,1.6fr) minmax(0,1.2fr);gap:14px;margin-top:12px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    h1{margin:0 0 8px;font-size:1.35rem;color:var(--blue2)}
    .sub{margin:0 0 10px;color:var(--muted);font-size:.95rem}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,textarea{
      width:100%; border:1px solid var(--border);border-radius:12px;padding:10px 12px;
      font-size:.95rem;background:#fff; color:var(--text)
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(29,78,216,.15)}
    .row .grow{flex:1 1 220px}
    .btn{border:none;border-radius:999px;padding:10px 14px;font-size:.92rem;cursor:pointer;font-weight:650;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--blue);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn.accent{background:var(--yellow);color:#111827}
    .btn.danger{background:#fee2e2;color:#b91c1c}
    .small{font-size:.82rem;color:var(--muted)}
    .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .status .pill{background:#fff;border:1px solid var(--border);color:var(--muted)}
    .status .pill.loading{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
    .list{list-style:none;padding:0;margin:0;max-height:520px;overflow:auto}
    .item{border:1px solid var(--border);border-radius:14px;padding:10px;margin-bottom:8px;display:grid;grid-template-columns:minmax(0,1fr) auto;gap:10px}
    @media (max-width:600px){.item{grid-template-columns:1fr}}
    .title{font-weight:800;margin:0 0 4px}
    .meta{font-size:.85rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{font-size:.75rem;border-radius:999px;padding:3px 8px;border:1px solid var(--border);background:#f8fafc;color:#334155}
    .badge.school{background:#e0f2fe;border-color:#bae6fd;color:#075985}
    .badge.sports{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .badge.camp{background:#fef9c3;border-color:#fde68a;color:#854d0e}
    .badge.other{background:#f1f5f9;border-color:#e2e8f0;color:#334155}
    .line{margin-top:6px;font-size:.88rem}
    .line strong{color:var(--text)}
    .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .actions label{display:flex;gap:8px;align-items:center;font-size:.85rem;color:var(--muted);user-select:none}
    .link a{color:var(--blue);text-decoration:none;font-weight:700}
    .link a:hover{text-decoration:underline}
    .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:var(--blue2);color:#fff;padding:10px 14px;border-radius:999px;opacity:0;pointer-events:none;transition:.2s;box-shadow:0 10px 20px rgba(15,23,42,.35)}
    .toast.show{opacity:1}
    .divider{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">KidCal<span>.</span></div>
      <div class="tag">San Luis Obispo County kids signups, deadlines & family events</div>
    </div>
    <div class="pill">üìç SLO County ‚Ä¢ Web + App</div>
  </header>

  <main>
    <!-- LEFT: Search + Results -->
    <section class="card">
      <h1>Find signups you don‚Äôt want to miss</h1>
      <p class="sub">Search by <strong>ZIP</strong> or <strong>city</strong>. Pick a radius, filter by type/date, then select items to export to your calendar.</p>

      <div class="row">
        <div class="grow">
          <input id="q" placeholder="Try: 93422 or Atascadero" autocomplete="off" />
        </div>
        <button class="btn primary" id="btnSearch">Search</button>
        <button class="btn ghost" id="btnClear">Show all</button>
      </div>

      <div class="row" style="margin-top:8px">
        <select id="type">
          <option value="all">All types</option>
          <option value="school">School</option>
          <option value="sports">Sports</option>
          <option value="camp">Camps / activities</option>
          <option value="other">Other</option>
        </select>
        <select id="time">
          <option value="all">All dates</option>
          <option value="upcoming">Upcoming only</option>
          <option value="past">Past only</option>
        </select>
        <select id="radius">
          <option value="0">Exact ZIP / city</option>
          <option value="5">Within 5 miles</option>
          <option value="10">Within 10 miles</option>
          <option value="25">Within 25 miles</option>
        </select>
      </div>

      <div class="status">
        <span id="count" class="pill loading">Loading‚Ä¶</span>
        <span id="filterLabel" class="pill" style="display:none"></span>
      </div>

      <div class="divider"></div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="small"><strong>Select</strong> events, then download .ics</div>
        <div class="row">
          <button class="btn ghost" id="btnSelectAll">Select all</button>
          <button class="btn ghost" id="btnSelectNone">Select none</button>
        </div>
      </div>

      <ul id="list" class="list"></ul>
      <p id="empty" class="small" style="display:none">No matches. Try a different ZIP/city or ‚ÄúShow all‚Äù.</p>
    </section>

    <!-- RIGHT: Calendar + Submit -->
    <section class="card">
      <h1>Calendar + Submissions</h1>
      <p class="sub">Selections are saved on this device. Download an <strong>.ics</strong> file and add to Apple/Google/Outlook.</p>

      <div class="row">
        <button class="btn accent" id="btnIcs">‚¨áÔ∏è Download selected .ics</button>
        <button class="btn danger" id="btnClearSel">üßπ Clear selections</button>
      </div>

      <div class="divider"></div>

      <h1 style="font-size:1.1rem">Submit a program</h1>
      <p class="sub">Submissions go to you for review first (not auto-posted).</p>

      <div class="row">
        <input id="s_name" placeholder="Your name (optional)" />
        <input id="s_email" placeholder="Your email (optional)" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_location" placeholder="City or area (include ZIP if possible)" />
        <input id="s_zip" placeholder="ZIP (optional)" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_title" placeholder="Program / event title *" />
        <input id="s_org" placeholder="Organization" />
      </div>
      <div class="row" style="margin-top:8px">
        <select id="s_type">
          <option value="school">School</option>
          <option value="sports">Sports</option>
          <option value="camp">Camp / activity</option>
          <option value="other" selected>Other</option>
        </select>
        <input id="s_url" placeholder="Direct link *" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_open" placeholder="Registration opens (YYYY-MM-DD)" />
        <input id="s_close" placeholder="Registration deadline (YYYY-MM-DD)" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_event" placeholder="Event date (YYYY-MM-DD)" />
        <input id="s_age" placeholder="Ages (e.g., 4‚Äì6)" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_cost" placeholder="Cost (e.g., Free / $120)" />
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="s_notes" rows="3" placeholder="Short description for parents"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnSubmit">Submit for review</button>
      </div>

      <p class="small" style="margin-top:10px">Tip: install this as an app from your browser menu ‚Üí ‚ÄúAdd to Home Screen‚Äù.</p>
    </section>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
  /***********************
   * CONFIG ‚Äì FILL THESE
   ***********************/
  // 1) Apps Script Web App URL (deployed) ‚Äì used for public JSON + submissions
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx4x7qEmgfJOWeuN_ny4dalkUBf9J9l-KvXGkY9ZJx5STBFMqMHe9tp3lUbstCWfHx3/exec";

  // 2) Optional fallback CSV (published kidcal_public as CSV). If you use WEBAPP_URL?public=1, you can skip this.
  const PUBLIC_CSV_URL = "";

  const EXTRA_EVENTS_URL = "./extra-events.json"; // optional

  /***********************
   * State
   ***********************/
  const el = (id) => document.getElementById(id);

  let EVENTS = [];
  let current = [];
  let selected = loadSelected();

  const ZIP_COORD_CACHE = {};
  const STORAGE_KEY = "kidcal-selected-v2";

  function toast(msg){
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function loadSelected(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    }catch{ return []; }
  }
  function saveSelected(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(selected));
  }

  /***********************
   * Fetch Data
   ***********************/
  async function fetchPublicData(){
    el("count").classList.add("loading");
    el("count").textContent = "Loading‚Ä¶";

    // Prefer WEBAPP public JSON
    if (WEBAPP_URL && WEBAPP_URL.startsWith("http")) {
      const res = await fetch(`${WEBAPP_URL}?public=1&t=${Date.now()}`, { cache:"no-store" });
      if (res.ok){
        const data = await res.json();
        const mapped = (data || []).map((r, idx)=>mapRowToEvent(r, "pub-" + idx)).filter(Boolean);
        if (mapped.length){
          EVENTS = mapped;
          current = [...EVENTS];
          render();
          toast(`Loaded ${EVENTS.length} programs`);
          return;
        }
      }
    }

    // Fallback CSV
    if (PUBLIC_CSV_URL) {
      const res = await fetch(`${PUBLIC_CSV_URL}&t=${Date.now()}`, { cache:"no-store" });
      if (res.ok){
        const text = await res.text();
        const parsed = parseCsv(text);
        const mapped = parsed.rows.map((r, idx)=>mapRowToEvent(r, "csv-" + idx)).filter(Boolean);
        EVENTS = mapped;
        current =_togglecopy();
        render();
        toast(`Loaded ${EVENTS.length} programs`);
        return;
      }
    }

    toast("Could not load data yet. Check your WEBAPP_URL deployment.");
    el("count").classList.remove("loading");
  }

  function _togglecopy(){ return [...EVENTS]; }

  function mapRowToEvent(row, fallbackId){
    const title = row.title || "";
    const url = row.url || row.link || "";
    if (!title || !url) return null;

    const location_label = row.location_label || row.city || row.location || "";
    const zip = row.zip || extractZip(location_label) || "";

    const date = pickPrimaryDate(row);
    return {
      id: row.item_id || row.id || fallbackId,
      location_label,
      zip,
      title,
      org: row.org || row.provider || "",
      type: normalizeType(row.type),
      registration_open: row.registration_open || "",
      registration_close: row.registration_close || "",
      event_date: row.event_date || row.primary_date || row.date || "",
      date, // used for filtering
      url,
      notes: row.notes || "",
      age_range: row.age_range || row.ageRange || "",
      cost: row.cost || ""
    };
  }

  async function fetchExtra(){
    try{
      const res = await fetch(`${EXTRA_EVENTS_URL}?t=${Date.now()}`, { cache:"no-store" });
      if (!res.ok) return;
      const data = await res.json();
      const mapped = (data || []).map((r, idx)=>mapRowToEvent(r, "extra-" + idx)).filter(Boolean);
      if (mapped.length){
        EVENTS = EVENTS.concat(mapped);
        current = [...EVENTS];
        render();
        toast(`Loaded ${mapped.length} extra items`);
      }
    }catch{}
  }

  /***********************
   * Search + Filters
   ***********************/
  function normalizeType(v){
    const t = String(v || "").toLowerCase().trim();
    if (!t) return "other";
    if (t === "event") return "other";
    if (["school","sports","camp","other"].includes(t)) return t;
    return "other";
  }

  function extractZip(str){
    const m = String(str || "").match(/\b\d{5}\b/);
    return m ? m[0] : "";
  }

  function pickPrimaryDate(row){
    return row.registration_close || row.registration_open || row.event_date || row.primary_date || row.date || "";
  }

  function isDateOk(ev){
    const mode = el("time").value;
    if (mode === "all") return true;
    const iso = ev.date;
    if (!iso) return true;
    const parts = iso.split("-");
    if (parts.length !== 3) return true;
    const d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
    if (isNaN(d.getTime())) return true;

    const today = new Date(); today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);

    if (mode === "upcoming") return d >= today;
    if (mode === "past") return d < today;
    return true;
  }

  async function getZipCoords(zip){
    if (!zip) return null;
    if (ZIP_COORD_CACHE[zip]) return ZIP_COORD_CACHE[zip];
    const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
    if (!res.ok) return null;
    const data = await res.json();
    const p = data.places && data.places[0];
    if (!p) return null;
    const c = { lat: parseFloat(p.latitude), lng: parseFloat(p.longitude) };
    ZIP_COORD_CACHE[zip] = c;
    return c;
  }

  function distanceMiles(a,b){
    const R=3958.8, toRad=(x)=>x*Math.PI/180;
    const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
    return 2*R*Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
  }

  async function runSearch(){
    const qRaw = (el("q").value || "").trim();
    const q = qRaw.toLowerCase();
    const radius = Number(el("radius").value || 0);

    // clear distance flags
    EVENTS.forEach(e => delete e.distanceFromSearch);

    if (!qRaw){
      current = [...EVENTS];
      el("filterLabel").style.display = "none";
      render();
      return;
    }

    // ZIP radius mode
    if (/^\d{5}$/.test(qRaw) && radius > 0){
      const center = await getZipCoords(qRaw);
      if (!center){
        current = EVENTS.filter(e => (e.zip||"").includes(qRaw) || (e.location_label||"").toLowerCase().includes(q));
        el("filterLabel").style.display = "inline-flex";
        el("filterLabel").textContent = `Filter: ${qRaw}`;
        render();
        return;
      }

      const out = [];
      for (const ev of EVENTS){
        if (!ev.zip) continue;
        const c = await getZipCoords(ev.zip);
        if (!c) continue;
        const dist = distanceMiles(center, c);
        if (dist <= radius){
          ev.distanceFromSearch = dist;
          out.push(ev);
        }
      }
      current = out.length ? out : EVENTS.filter(e => (e.zip||"").includes(qRaw) || (e.location_label||"").toLowerCase().includes(q));
      el("filterLabel").style.display = "inline-flex";
      el("filterLabel").textContent = `Within ${radius} mi of ${qRaw}`;
      render();
      return;
    }

    // text match city/zip/org/title
    current = EVENTS.filter(e =>
      (e.location_label||"").toLowerCase().includes(q) ||
      (e.zip||"").includes(qRaw) ||
      (e.title||"").toLowerCase().includes(q) ||
      (e.org||"").toLowerCase().includes(q)
    );
    el("filterLabel").style.display = "inline-flex";
    el("filterLabel").textContent = `Filter: ‚Äú${qRaw}‚Äù`;
    render();
  }

  function applyFilters(list){
    const type = el("type").value;
    return list.filter(ev => {
      if (type !== "all" && ev.type !== type) return false;
      if (!isDateOk(ev)) return false;
      return true;
    });
  }

  /***********************
   * Render
   ***********************/
  function render(){
    const list = applyFilters(current);
    const ul = el("list");
    ul.innerHTML = "";

    el("count").classList.remove("loading");
    el("count").textContent = `Showing ${list.length} of ${EVENTS.length}`;

    el("empty").style.display = list.length ? "none" : "block";
    if (!list.length) return;

    list.forEach(ev => {
      const li = document.createElement("li");
      li.className = "item";

      const left = document.createElement("div");

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = ev.title;

      const meta = document.createElement("div");
      meta.className = "meta";

      const b = document.createElement("span");
      b.className = "badge " + (ev.type || "other");
      b.textContent = ev.type.toUpperCase();

      const loc = document.createElement("span");
      loc.textContent = ev.location_label || "SLO County";

      const org = document.createElement("span");
      org.textContent = ev.org ? `‚Ä¢ ${ev.org}` : "";

      meta.appendChild(b);
      meta.appendChild(loc);
      if (ev.org) meta.appendChild(org);

      if (typeof ev.distanceFromSearch === "number"){
        const d = document.createElement("span");
        d.textContent = `‚Ä¢ ${ev.distanceFromSearch.toFixed(1)} mi`;
        meta.appendChild(d);
      }

      const line = document.createElement("div");
      line.className = "line";
      const dl = deadlineLabel(ev);
      line.innerHTML = dl ? `<strong>${dl}</strong>` : "";

      const desc = document.createElement("div");
      desc.className = "small";
      desc.textContent = ev.notes || "";

      const link = document.createElement("div");
      link.className = "link";
      link.innerHTML = `<a href="${ev.url}" target="_blank" rel="noopener noreferrer">Open info / registration ‚Üí</a>`;

      left.appendChild(t);
      left.appendChild(meta);
      if (dl) left.appendChild(line);
      if (ev.notes) left.appendChild(desc);
      left.appendChild(link);

      const right = document.createElement("div");
      right.className = "actions";

      const lab = document.createElement("label");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.some(s => s.id === ev.id);
      cb.addEventListener("change", () => {
        if (cb.checked) addSelected(ev);
        else removeSelected(ev.id);
      });
      lab.appendChild(cb);
      lab.appendChild(document.createTextNode(" Select"));

      right.appendChild(lab);

      li.appendChild(left);
      li.appendChild(right);
      ul.appendChild(li);
    });
  }

  function deadlineLabel(ev){
    const open = ev.registration_open;
    const close = ev.registration_close;
    const date = ev.event_date || ev.date;

    if (open && close) return `Register: ${open} ‚Üí ${close}`;
    if (close) return `Register by: ${close}`;
    if (open) return `Registration opens: ${open}`;
    if (date) return `Date: ${date}`;
    return "";
  }

  function addSelected(ev){
    if (selected.some(s => s.id === ev.id)) return;
    selected.push({
      id: ev.id, title: ev.title, location_label: ev.location_label, org: ev.org,
      date: ev.date, registration_close: ev.registration_close, registration_open: ev.registration_open, event_date: ev.event_date
    });
    saveSelected();
    toast("Selected");
  }
  function removeSelected(id){
    selected = selected.filter(s => s.id !== id);
    saveSelected();
    toast("Unselected");
  }

  /***********************
   * ICS export
   ***********************/
  function escIcs(s){
    return String(s||"").replace(/\\/g,"\\\\").replace(/,/g,"\\,").replace(/;/g,"\\;").replace(/\n/g,"\\n");
  }
  function icsDate(iso){
    if (!iso) return "20250101";
    return String(iso).replace(/-/g,"").slice(0,8);
  }
  function downloadIcs(){
    if (!selected.length){
      toast("Select at least one item first");
      return;
    }
    const lines = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//KidCal//SLO//EN"
    ];

    selected.forEach((s, i) => {
      const dt = icsDate(s.registration_close || s.event_date || s.date || s.registration_open);
      lines.push("BEGIN:VEVENT");
      lines.push(`UID:kidcal-${s.id || i}@kidcal`);
      lines.push(`SUMMARY:${escIcs(s.title)}`);
      const desc = `${s.location_label || ""}${s.org ? " ¬∑ " + s.org : ""}`;
      lines.push(`DESCRIPTION:${escIcs(desc)}`);
      lines.push(`DTSTART;VALUE=DATE:${dt}`);
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");
    const blob = new Blob([lines.join("\r\n")], { type:"text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kidcal-selected.ics";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast("Downloaded .ics");
  }

  /***********************
   * Submission
   ***********************/
  async function submit(){
    if (!WEBAPP_URL || !WEBAPP_URL.startsWith("http")){
      toast("Set WEBAPP_URL first (Apps Script deployment)");
      return;
    }
    const payload = {
      name: el("s_name").value.trim(),
      email: el("s_email").value.trim(),
      location_label: el("s_location").value.trim(),
      zip: el("s_zip").value.trim(),
      title: el("s_title").value.trim(),
      org: el("s_org").value.trim(),
      type: el("s_type").value,
      url: el("s_url").value.trim(),
      registration_open: el("s_open").value.trim(),
      registration_close: el("s_close").value.trim(),
      event_date: el("s_event").value.trim(),
      age_range: el("s_age").value.trim(),
      cost: el("s_cost").value.trim(),
      notes: el("s_notes").value.trim()
    };
    if (!payload.title || !payload.url){
      toast("Title and link are required");
      return;
    }

    const res = await fetch(WEBAPP_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>null);
    if (data && data.ok){
      toast("Submitted for review ‚úÖ");
      ["s_location","s_zip","s_title","s_org","s_url","s_open","s_close","s_event","s_age","s_cost","s_notes"].forEach(id=>el(id).value="");
    } else {
      toast("Submit failed. Check Apps Script permissions.");
    }
  }

  /***********************
   * CSV fallback parser
   ***********************/
  function parseCsv(text){
    const rows = [];
    let row=[], cur="", inQuotes=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if (ch === '"' && inQuotes && next === '"'){ cur+='"'; i++; continue; }
      if (ch === '"'){ inQuotes=!inQuotes; continue; }
      if (ch === "," && !inQuotes){ row.push(cur.trim()); cur=""; continue; }
      if ((ch === "\n" || ch === "\r") && !inQuotes){
        if (cur.length || row.length){ row.push(cur.trim()); rows.push(row); }
        cur=""; row=[];
        if (ch === "\r" && next === "\n") i++;
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur.trim()); rows.push(row); }

    const headers = (rows.shift() || []).map(h=>h.trim());
    const out = rows.map(r=>{
      const o={}; headers.forEach((h,idx)=>o[h]=r[idx]||""); return o;
    });
    return { headers, rows: out };
  }

  /***********************
   * UI wiring
   ***********************/
  el("btnSearch").addEventListener("click", runSearch);
  el("btnClear").addEventListener("click", ()=>{ el("q").value=""; current=[...EVENTS]; el("filterLabel").style.display="none"; render(); });
  el("q").addEventListener("keyup", (e)=>{ if (e.key==="Enter") runSearch(); });
  el("type").addEventListener("change", render);
  el("time").addEventListener("change", render);
  el("radius").addEventListener("change", render);
  el("btnSelectAll").addEventListener("click", ()=>{
    const list = applyFilters(current);
    list.forEach(addSelected);
    render();
    toast("Selected all on screen");
  });
  el("btnSelectNone").addEventListener("click", ()=>{ selected=[]; saveSelected(); render(); toast("Cleared selections"); });
  el("btnIcs").addEventListener("click", downloadIcs);
  el("btnClearSel").addEventListener("click", ()=>{ selected=[]; saveSelected(); render(); toast("Cleared selections"); });
  el("btnSubmit").addEventListener("click", submit);

  // Init
  fetchPublicData().then(fetchExtra);
</script>

<script>
  // PWA service worker (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
