<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KidCal ‚Äì Kids‚Äô Signups in One Place</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="KidCal helps parents see all kids‚Äô signups and events in one simple list."
  />
  <style>
    :root {
      --blue: #1d4ed8;
      --blue-dark: #1e3a8a;
      --blue-soft: #dbeafe;
      --yellow: #facc15;
      --bg: #f3f4ff;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.15);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: #ffffff;
      color: var(--text-main);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo {
      font-weight: 800;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
      color: var(--blue-dark);
    }

    .logo span {
      color: var(--yellow);
    }

    .tagline {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .badge {
      background: var(--blue-soft);
      color: var(--blue-dark);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge span {
      font-size: 1rem;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 880px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 14px;
    }

    .card + .card {
      margin-top: 12px;
    }

    .hero-title {
      font-size: 1.5rem;
      margin: 0 0 4px;
      color: var(--blue-dark);
    }

    .hero-sub {
      margin: 0 0 10px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .hero-sub strong {
      color: var(--text-main);
    }

    .controls {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .step-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--blue-dark);
      margin-bottom: 4px;
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--yellow);
      color: #111827;
      font-size: 0.8rem;
    }
    
    .step-text {
      letter-spacing: 0.01em;
    }
    
    .step-label--subtle {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .step-label--inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .controls label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .search-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .search-row input {
      flex: 1 1 180px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
    }

    .search-row input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }

    .filters-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      align-items: center;
    }

    .filters-left {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .filters-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 0.85rem;
      background: #f9fafb;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--blue);
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: var(--text-main);
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      .search-row {
        flex-direction: column;
      }

      .filters-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .filters-right {
        width: 100%;
      }

      .filters-right .btn {
        flex: 1 1 auto;
        width: 100%;
      }

      .btn {
        width: 100%;
      }
    }

    .status-line {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: var(--blue-soft);
      color: var(--blue-dark);
    }

    .status-pill.loading {
      background: #fee2e2;
      color: #b91c1c;
    }

    .list-title {
      font-size: 1rem;
      margin: 0 0 4px;
    }

    .list-sub {
      margin: 0 0 10px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .events-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 380px;
      overflow-y: auto;
    }

    .event-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 10px 10px;
      margin-bottom: 8px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) auto;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .event-item {
        grid-template-columns: 1fr;
      }
    }

    .event-main {
      font-size: 0.9rem;
    }

    .event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .event-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .city-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: var(--blue-dark);
      font-size: 0.75rem;
      margin-right: 6px;
    }

    .event-deadline {
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .event-notes {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .event-link a {
      font-size: 0.8rem;
      color: var(--blue);
      text-decoration: none;
    }

    .event-link a:hover {
      text-decoration: underline;
    }

    .event-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-between;
      gap: 6px;
      text-align: right;
    }

    .type-pill {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      text-transform: capitalize;
    }

    .type-pill.school {
      background: #dbeafe;
      color: #1e3a8a;
    }

    .type-pill.sports {
      background: #dcfce7;
      color: #166534;
    }

    .type-pill.camp {
      background: #fef9c3;
      color: #854d0e;
    }

    .no-events {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .reminders-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.9rem;
      max-height: 220px;
      overflow-y: auto;
    }

    .reminder-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 9px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      background: #f9fafb;
    }

    .reminder-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .reminder-title {
      font-weight: 600;
    }

    .reminder-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .btn-icon {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .empty-hint {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .provider-list {
      margin: 6px 0 0;
      padding-left: 18px;
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .provider-list li {
      margin-bottom: 4px;
    }

    .provider-list a {
      color: var(--blue);
      text-decoration: none;
    }

    .provider-list a:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 14px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--blue-dark);
      color: #f9fafb;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.86rem;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 40;
    }

    .toast.toast--visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="logo">KidCal<span>.</span></div>
        <div class="tagline">All your kids‚Äô signups in one place</div>
      </div>
      <div class="badge">
        <span>üìç</span> San Luis Obispo County
      </div>
    </header>

    <main>
      <!-- LEFT: Search + Event list -->
      <section>
        <div class="card">
    <h1 class="hero-title">
      Find every signup your kids shouldn‚Äôt miss!
    </h1>
    <p class="hero-sub">
      Never miss a moment&mdash;organize every signup into your own simple calendar.
    </p>

<div class="controls">
  <div class="step-label">
  <span class="step-number">1</span>
  <span class="step-text">Search by city or ZIP</span>
</div>
<div class="search-row">
    <input
      id="cityInput"
      type="text"
      placeholder="Try: 93422 or Atascadero‚Ä¶"
      autocomplete="off"
    />
    <button class="btn btn-primary" id="btnFind">Search</button>
    <button class="btn btn-secondary" id="btnSample">Show everything</button>
  </div>

  <div class="filters-row">
    <div class="filters-left">
      <div class="step-label step-label--inline">
      <span class="step-number">2</span>
      <span class="step-text">Type and distance</span>
    </div>
    <select id="typeFilter">
        <option value="all">All</option>
        <option value="school">School</option>
        <option value="sports">Sports</option>
        <option value="camp">Camps / activities</option>
        <option value="other">Other / directories</option>
      </select>

      <!-- NEW: distance radius filter -->
      <select id="radiusFilter">
        <option value="0">Exact ZIP / city</option>
        <option value="5">Within 5 miles</option>
        <option value="10">Within 10 miles</option>
        <option value="25">Within 25 miles</option>
      </select>
    </div>

    <div class="filters-right">
      <!-- NEW: time filter: upcoming / past / all -->
    <select id="timeFilter">
      <option value="all">All dates</option>
      <option value="upcoming">Upcoming only</option>
      <option value="past">Past only</option>
    </select>

      <span class="badge" style="background:#fef9c3;">
        <span>‚≠ê</span> Tap ‚ÄúAdd reminder‚Äù to save
      </span>
    </div>
  </div>

  <div class="status-line">
    <span id="eventsCounter" class="status-pill">Loading events‚Ä¶</span>
    <span id="cityFilterLabel" class="status-pill" style="display:none;"></span>
  </div>
</div>
        </div>

        <div class="card">
          <div class="step-label">
          <span class="step-number">3</span>
          <span class="step-text">Add things you do not want to miss</span>
        </div>
        <p class="list-title">Kids‚Äô signups and events</p>
        <p class="list-sub">Tap ‚ÄúAdd reminder‚Äù next to anything important.</p>

          <ul id="eventsList" class="events-list"></ul>
          <p id="eventsEmpty" class="no-events" style="display:none;">
            No matches right now. Try a different area or ‚ÄúShow everything‚Äù.
          </p>
        </div>
      </section>

      <!-- RIGHT: Reminders + provider info -->
      <section>
        <div class="card">
          <div class="step-label">
  <span class="step-number">4</span>
  <span class="step-text">Download your calendar</span>
</div>
<p class="list-title">My reminders</p>
<p class="list-sub">
  Saved on this device. Download a simple .ics file to add to your calendar.
</p>

<div class="filters-row" style="margin-top:0;">
  <div class="filters-left">
    <span class="badge">
      <span>üìÖ</span> Download .ics when you are ready
    </span>
  </div>
            <div class="filters-right">
              <button class="btn btn-outline btn-small" id="btnDownloadIcs">
                ‚¨áÔ∏è Download .ics
              </button>
              <button class="btn btn-danger btn-small" id="btnClearReminders">
                üßπ Clear
              </button>
            </div>
          </div>

          <ul id="remindersList" class="reminders-list"></ul>
          <p id="remindersEmpty" class="empty-hint">
            No reminders yet. Add one from the list on the left.
          </p>
        </div>

        <div class="card">
  <p class="list-title" style="color:#1d4ed8; font-weight:700; font-size:1.05rem;">
    üì£ For schools & youth programs
  </p>
  <p class="list-sub" style="margin-bottom:12px;">
    Add your programs so local families can find you.
  </p>

  <ul class="provider-list" style="padding-left:0; list-style:none;">
    <li style="margin-bottom:8px; display:flex; align-items:flex-start; gap:8px;">
      <span style="font-size:1.1rem;">üìÑ</span>
      <span>
        Open the shared sheet to add or edit programs:
        <li style="margin-bottom:8px; display:flex; align-items:flex-start; gap:8px;">
  <span style="font-size:1.1rem;">üìÑ</span>
  <span>
    Add your programs on the shared sheet:
    <a
      class="btn btn-primary btn-small"
      href="https://docs.google.com/spreadsheets/d/1Um6YHIKfc0L918-Xx3_TJyBCuX5KXVBoH4JUOjwqlZM/edit?gid=0#gid=0"
      target="_blank"
      rel="noopener noreferrer"
    >
      ‚úèÔ∏è Add your programs
    </a>
  </span>
</li>
      </span>
    </li>

    <li style="margin-bottom:8px; display:flex; align-items:flex-start; gap:8px;">
      <span style="font-size:1.1rem;">üìù</span>
      <span>One row per program or season.</span>
    </li>

    <li style="margin-bottom:8px; display:flex; align-items:flex-start; gap:8px;">
      <span style="font-size:1.1rem;">üí°</span>
      <span>Fill in your location, title, type, dates, org name and a direct link.</span>
    </li>
  </ul>
</div>

        <footer>
          KidCal collects local kids‚Äô signups and events in one place so parents
          don‚Äôt have to dig through flyers, emails and websites.
        </footer>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

 <script>
  // Google Sheet CSV URL (published to web as CSV)
  const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/1Um6YHIKfc0L918-Xx3_TJyBCuX5KXVBoH4JUOjwqlZM/export?format=csv&gid=952020057";

  // Optional external JSON feed URL (extra web data)
  const EXTRA_EVENTS_URL =
    "https://kidcal-hub.github.io/KidCal/extra-events.json";

  // Fallback sample events
  const SAMPLE_EVENTS = [
    {
      id: "sample-1",
      city: "Atascadero CA 93422",
      type: "school",
      title: "AUSD TK & Kinder Enrollment 2025‚Äì26",
      date: "2025-03-31",
      deadlineLabel: "Register between Mar 1 and Mar 31 2025",
      provider: "Atascadero Unified School District",
      link: "https://atascaderousd.aeries.net/air/",
      notes: "Online enrollment for new TK and Kindergarten students.",
      zip: "93422"
    },
    {
      id: "sample-2",
      city: "Atascadero CA 93422",
      type: "sports",
      title: "Atascadero Youth Soccer League Fall 2025",
      date: "2025-06-16",
      deadlineLabel: "Register between Apr 8 and Jun 16 2025",
      provider: "Atascadero Youth Soccer League",
      link: "https://www.atascaderosoccer.org/",
      notes: "Games start in early September.",
      zip: "93422"
    }
  ];

  let EVENTS = [...SAMPLE_EVENTS];
  let currentEvents = [...EVENTS];

  const STORAGE_KEY = "kidcal-reminders-v1";
  let reminders = loadRemindersFromStorage();
  let isLoadingEvents = false;
  let pendingSources = 0;

  // ZIP ‚Üí {lat,lng} cache
  const ZIP_COORD_CACHE = {};

  // DOM elements
  const cityInput = document.getElementById("cityInput");
  const typeFilter = document.getElementById("typeFilter");
  const radiusFilter = document.getElementById("radiusFilter");
  const timeFilter = document.getElementById("timeFilter");
  const btnFind = document.getElementById("btnFind");
  const btnSample = document.getElementById("btnSample");
  const eventsList = document.getElementById("eventsList");
  const eventsEmpty = document.getElementById("eventsEmpty");
  const eventsCounter = document.getElementById("eventsCounter");
  const cityFilterLabel = document.getElementById("cityFilterLabel");

  const remindersList = document.getElementById("remindersList");
  const remindersEmpty = document.getElementById("remindersEmpty");
  const btnClearReminders = document.getElementById("btnClearReminders");
  const btnDownloadIcs = document.getElementById("btnDownloadIcs");

  function showToast(message) {
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = message;
    toast.classList.add("toast--visible");
    clearTimeout(window._kidcalToastTimeout);
    window._kidcalToastTimeout = setTimeout(() => {
      toast.classList.remove("toast--visible");
    }, 2000);
  }

  // CSV parser (simple, no commas inside cells)
  function parseCsv(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return { headers: [], rows: [] };

    const headers = lines[0].split(",").map((h) => h.trim());
    const rows = lines.slice(1).map((line) => {
      const cells = line.split(",").map((c) => c.trim());
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = cells[i] || "";
      });
      return obj;
    });

    return { headers, rows };
  }

  function pickPrimaryDate(row) {
    return (
      row.registration_close ||
      row.registration_open ||
      row.event_date ||
      ""
    );
  }

  function formatDate(iso) {
    if (!iso) return "";
    const parts = iso.split("-");
    if (parts.length !== 3) return iso;
    const [y, m, d] = parts;
    const monthNames = [
      "Jan","Feb","Mar","Apr","May","Jun",
      "Jul","Aug","Sep","Oct","Nov","Dec"
    ];
    const monthIndex = parseInt(m, 10) - 1;
    const monthName = monthNames[monthIndex] || m;
    const day = String(parseInt(d, 10));
    return `${monthName} ${day} ${y}`;
  }

  function buildDeadlineLabel(row) {
    const open = row.registration_open;
    const close = row.registration_close;
    const event = row.event_date;
    const notes = row.notes;

    if (open && close) {
      return `Register between ${formatDate(open)} and ${formatDate(close)}`;
    }

    if (close) {
      return `Register by ${formatDate(close)}`;
    }

    if (open) {
      return `Registration opens ${formatDate(open)}`;
    }

    if (event) {
      return `Event on ${formatDate(event)}`;
    }

    return notes || "";
  }

  function normalizeType(raw) {
    const t = (raw || "").toLowerCase().trim();
    if (!t) return "other";
    if (t === "event") return "other";
    return t;
  }

   function extractZip(str) {
  if (!str) return "";
  const match = String(str).match(/\b\d{5}\b/);
  return match ? match[0] : "";
}

   async function getZipCoords(zip) {
    if (!zip) return null;
    if (ZIP_COORD_CACHE[zip]) return ZIP_COORD_CACHE[zip];

    try {
      const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
      if (!res.ok) return null;
      const data = await res.json();
      const place = data.places && data.places[0];
      if (!place) return null;
      const coords = {
        lat: parseFloat(place.latitude),
        lng: parseFloat(place.longitude)
      };
      ZIP_COORD_CACHE[zip] = coords;
      return coords;
    } catch (e) {
      console.warn("Could not look up ZIP", zip, e);
      return null;
    }
  }

  function distanceMiles(a, b) {
    if (!a || !b) return Infinity;
    const R = 3958.8;
    const toRad = (deg) => (deg * Math.PI) / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const h =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1) * Math.cos(lat2) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
    return R * c;
  }

  // Fetch from Google Sheet CSV
  async function fetchSheetData() {
    try {
      pendingSources++;
      isLoadingEvents = true;
      updateStatusUi();

      const res = await fetch(SHEET_URL);
      if (!res.ok) throw new Error("Network error fetching sheet");
      const text = await res.text();
      const parsed = parseCsv(text);

      if (!parsed.rows || !parsed.rows.length) {
        console.warn("Sheet has no rows; keeping sample events.");
        return;
      }

      const mapped = parsed.rows
        .map((row, idx) => {
          const title = row.title;
          const url = row.url;

          if (!title || !url) return null;

          const cityLabel = row.location_label || row.location_id || "";
          const eventType = normalizeType(row.type);
          const date = pickPrimaryDate(row);
          const deadlineLabel = buildDeadlineLabel(row);

          return {
            id: row.item_id || "sheet-" + idx,
            city: cityLabel,
            type: eventType,
            title: title,
            date: date,
            deadlineLabel: deadlineLabel,
            provider: row.org,
            link: url,
            notes: row.notes,
            ageRange: row.age_range,
            cost: row.cost,
            // NEW: try to get a ZIP from an explicit column, then fall back to the city string
            zip: row.zip || row.location_zip || row.location_area || extractZip(cityLabel)
          };
        })
        .filter(Boolean);

      if (mapped.length) {
        EVENTS = mapped;
        currentEvents = [...EVENTS];
        renderEvents();
        showToast(`Loaded ${mapped.length} programs from KidCal sheet`);
      } else {
        console.warn("Sheet rows did not have required fields; keeping samples.");
      }
    } catch (e) {
      console.warn("Failed to load sheet data; keeping sample events.", e);
    } finally {
      pendingSources--;
      if (pendingSources <= 0) {
        isLoadingEvents = false;
      }
      updateStatusUi();
      renderEvents();
    }
  }

  // Fetch additional events from a JSON feed on the web (optional)
  async function fetchExternalEvents() {
    try {
      pendingSources++;
      isLoadingEvents = true;
      updateStatusUi();

      const res = await fetch(EXTRA_EVENTS_URL, { cache: "no-store" });
      if (!res.ok) {
        console.warn("External events feed not available", res.status);
        return;
      }

      const data = await res.json();

      const mapped = (data || []).map((item, idx) => {
        const cityLabel = item.city || item.location_label || "";

        return {
          id: item.id || "external-" + idx,
          city: cityLabel,
          type: normalizeType(item.type),
          title: item.title,
          date: item.date || item.primary_date || "",
          deadlineLabel:
            item.deadlineLabel ||
            item.deadline ||
            item.registration_window ||
            "",
          provider: item.provider || item.org || "",
          link: item.link || item.url || "",
          notes: item.notes || "",
          ageRange: item.ageRange || item.age_range,
          cost: item.cost,
          zip: item.zip || item.postal_code || extractZip(cityLabel)
        };
      }).filter(ev => ev.title && ev.link);

      if (mapped.length) {
        EVENTS = EVENTS.concat(mapped);
        currentEvents = [...EVENTS];
        renderEvents();
        showToast(`Loaded ${mapped.length} extra programs from the web`);
      }
    } catch (e) {
      console.warn("Failed to load external events", e);
    } finally {
      pendingSources--;
      if (pendingSources <= 0) {
        isLoadingEvents = false;
      }
      updateStatusUi();
      renderEvents();
    }
  }

  function loadRemindersFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      console.warn("Could not load reminders", e);
      return [];
    }
  }

  function saveRemindersToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
    } catch (e) {
      console.warn("Could not save reminders", e);
    }
  }

  function prettyType(type) {
    const t = (type || "other").toLowerCase();
    switch (t) {
      case "school":
        return "School";
      case "sports":
        return "Sports";
      case "camp":
        return "Camp / activity";
      case "other":
        return "Other / directory";
      default:
        return t.charAt(0).toUpperCase() + t.slice(1);
    }
  }

  function isEventMatchingTime(ev) {
    const mode = (timeFilter.value || "upcoming").toLowerCase();
    if (mode === "all") return true;
    if (!ev.date) return true;

    const parts = ev.date.split("-");
    if (parts.length !== 3) return true;
    const y = Number(parts[0]);
    const m = Number(parts[1]) - 1;
    const d = Number(parts[2]);
    const eventDate = new Date(y, m, d);
    if (isNaN(eventDate.getTime())) return true;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    eventDate.setHours(0, 0, 0, 0);

    if (mode === "upcoming") return eventDate >= today;
    if (mode === "past") return eventDate < today;
    return true;
  }

  function updateStatusUi() {
    const total = EVENTS.length;
    const visible = currentEvents.length;

    if (isLoadingEvents) {
      eventsCounter.textContent = "Loading events‚Ä¶";
      eventsCounter.classList.add("loading");
    } else {
      eventsCounter.classList.remove("loading");
      if (visible === total) {
        eventsCounter.textContent = `Showing ${visible} program${visible === 1 ? "" : "s"}`;
      } else {
        eventsCounter.textContent = `Showing ${visible} of ${total} program${total === 1 ? "" : "s"}`;
      }
    }
  }

  function renderEvents() {
    eventsList.innerHTML = "";
    const filterType = typeFilter.value;

    const list = currentEvents.filter((ev) => {
      if (filterType !== "all" &&
          (ev.type || "other").toLowerCase() !== filterType) {
        return false;
      }
      return isEventMatchingTime(ev);
    });

    updateStatusUi();

    if (!list.length) {
      eventsEmpty.style.display = "block";
      return;
    }
    eventsEmpty.style.display = "none";

    list.forEach((ev) => {
      const li = document.createElement("li");
      li.className = "event-item";

      const main = document.createElement("div");
      main.className = "event-main";

      const title = document.createElement("div");
      title.className = "event-title";
      title.textContent = ev.title || "(No title)";

      const meta = document.createElement("div");
      meta.className = "event-meta";

      const cityTag = document.createElement("span");
      cityTag.className = "city-tag";
      cityTag.textContent = ev.city || "Unknown area";
      meta.appendChild(cityTag);

      if (ev.provider) {
        const providerSpan = document.createElement("span");
        providerSpan.textContent = ev.provider;
        meta.appendChild(providerSpan);
      }

      // Show distance if search by ZIP was used
      if (typeof ev.distanceFromSearch === "number") {
        const distSpan = document.createElement("span");
        distSpan.textContent = ` ¬∑ ${ev.distanceFromSearch.toFixed(1)} mi`;
        meta.appendChild(distSpan);
      }

      const deadline = document.createElement("div");
      deadline.className = "event-deadline";
      deadline.textContent = ev.deadlineLabel || "";

      const notes = document.createElement("div");
      notes.className = "event-notes";
      if (ev.notes) {
        notes.textContent = ev.notes;
      }

      const link = document.createElement("div");
      link.className = "event-link";
      if (ev.link) {
        const a = document.createElement("a");
        a.href = ev.link;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "Open registration / info ‚Üí";
        link.appendChild(a);
      }

      main.appendChild(title);
      main.appendChild(meta);
      if (ev.deadlineLabel) main.appendChild(deadline);
      if (ev.notes) main.appendChild(notes);
      main.appendChild(link);

      const actions = document.createElement("div");
      actions.className = "event-actions";

      const typePill = document.createElement("div");
      typePill.className = "type-pill " + (ev.type || "other");
      typePill.textContent = prettyType(ev.type);

      const btnAdd = document.createElement("button");
      btnAdd.className = "btn btn-secondary btn-small";
      btnAdd.textContent = "Add reminder";
      btnAdd.addEventListener("click", () => addReminder(ev));

      actions.appendChild(typePill);
      actions.appendChild(btnAdd);

      li.appendChild(main);
      li.appendChild(actions);

      eventsList.appendChild(li);
    });
  }

  function renderReminders() {
    remindersList.innerHTML = "";
    if (!reminders.length) {
      remindersEmpty.style.display = "block";
      return;
    }
    remindersEmpty.style.display = "none";

    reminders.forEach((r, index) => {
      const li = document.createElement("li");
      li.className = "reminder-item";

      const main = document.createElement("div");
      main.className = "reminder-main";

      const title = document.createElement("div");
      title.className = "reminder-title";
      title.textContent = r.title || "(No title)";

      const meta = document.createElement("div");
      meta.className = "reminder-meta";
      const bits = [];
      if (r.deadlineLabel) bits.push(r.deadlineLabel);
      if (r.city) bits.push(r.city);
      if (r.provider) bits.push(r.provider);
      meta.textContent = bits.join(" ¬∑ ");

      main.appendChild(title);
      main.appendChild(meta);

      const btnRemove = document.createElement("button");
      btnRemove.className = "btn-icon";
      btnRemove.textContent = "‚úï";
      btnRemove.title = "Remove";
      btnRemove.addEventListener("click", () => {
        reminders.splice(index, 1);
        saveRemindersToStorage();
        renderReminders();
        showToast("Removed from reminders");
      });

      li.appendChild(main);
      li.appendChild(btnRemove);
      remindersList.appendChild(li);
    });
  }

  function addReminder(ev) {
    const exists = reminders.some((r) => r.id === ev.id);
    if (exists) {
      showToast("Already in your reminders");
      return;
    }
    reminders.push({
      id: ev.id,
      title: ev.title,
      city: ev.city,
      provider: ev.provider,
      deadlineLabel: ev.deadlineLabel,
      date: ev.date
    });
    saveRemindersToStorage();
    renderReminders();
    showToast("Added to your reminders");
  }

  async function filterByZipRadius(centerZip, radiusMiles) {
    const centerCoords = await getZipCoords(centerZip);
    if (!centerCoords) {
      showToast("Couldn't locate that ZIP; using text match instead.");
      const q = centerZip.toLowerCase();
      currentEvents = EVENTS.filter(
        (ev) =>
          (ev.city || "").toLowerCase().includes(q) ||
          (ev.zip || "").includes(centerZip)
      );
      return;
    }

    const results = [];
    const zipCoordsLocal = {};

    for (const ev of EVENTS) {
      const z = (ev.zip || "").trim();
      if (!z) continue;
      if (!zipCoordsLocal[z]) {
        zipCoordsLocal[z] = await getZipCoords(z);
      }
      const c = zipCoordsLocal[z];
      if (!c) continue;
      const dist = distanceMiles(centerCoords, c);
      if (dist <= radiusMiles) {
        ev.distanceFromSearch = dist;
        results.push(ev);
      }
    }

      // After the for-loop:
      if (results.length) {
        currentEvents = results;
      } else {
        // Fallback: no ZIP matches, so use basic city/ZIP text filter
        const q = centerZip.toLowerCase();
        currentEvents = EVENTS.filter(
          (ev) =>
            (ev.city || "").toLowerCase().includes(q) ||
            (ev.zip || "").includes(centerZip)
        );
        showToast("No ZIP-radius matches; showing text matches instead.");
      }
    }

  async function handleFind() {
    const queryRaw = (cityInput.value || "").trim();
    const query = queryRaw.toLowerCase();
    const radiusMiles = parseFloat(radiusFilter.value || "0");

    // Clear any old distance state
    EVENTS.forEach(ev => { delete ev.distanceFromSearch; });

    if (!queryRaw) {
      currentEvents = [...EVENTS];
      cityFilterLabel.style.display = "none";
      renderEvents();
      return;
    }

    // If it's a 5-digit ZIP and radius > 0, use radius search
    if (/^\d{5}$/.test(queryRaw) && radiusMiles > 0) {
      await filterByZipRadius(queryRaw, radiusMiles);
      cityFilterLabel.style.display = "inline-flex";
      cityFilterLabel.textContent = `Within ${radiusMiles} mi of ${queryRaw}`;
      renderEvents();
      return;
    }

    // Fallback: text match on city/ZIP
    currentEvents = EVENTS.filter(
      (ev) =>
        (ev.city || "").toLowerCase().includes(query) ||
        (ev.zip || "").includes(queryRaw)
    );
    cityFilterLabel.style.display = "inline-flex";
    cityFilterLabel.textContent = `Filter: ‚Äú${queryRaw}‚Äù`;
    renderEvents();
  }

  function handleSample() {
    cityInput.value = "";
    EVENTS.forEach(ev => { delete ev.distanceFromSearch; });
    currentEvents = [...EVENTS];
    cityFilterLabel.style.display = "none";
    renderEvents();
  }

  function clearReminders() {
    if (!reminders.length) return;
    if (!confirm("Clear all reminders on this device?")) return;
    reminders = [];
    saveRemindersToStorage();
    renderReminders();
    showToast("All reminders cleared");
  }

  function escapeText(text) {
    return String(text)
      .replace(/,/g, "\\,")
      .replace(/;/g, "\\;")
      .replace(/\n/g, "\\n");
  }

  function generateIcsContent() {
    if (!reminders.length) {
      alert("No reminders yet. Add one before downloading.");
      return null;
    }

    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//KidCal//App//EN");

    reminders.forEach((r, idx) => {
      const dt = (r.date || "").replace(/-/g, "");
      const start = dt || "20250101";

      lines.push("BEGIN:VEVENT");
      lines.push(`UID:kidcal-${r.id || idx}@kidcal`);
      lines.push(`SUMMARY:${escapeText(r.title || "")}`);
      lines.push(
        `DESCRIPTION:${escapeText(
          `${r.city || ""}${r.provider ? " ¬∑ " + r.provider : ""}${
            r.deadlineLabel ? " ¬∑ " + r.deadlineLabel : ""
          }`
        )}`
      );
      lines.push(`DTSTART;VALUE=DATE:${start}`);
      lines.push("END:VEVENT");
    });

    lines.push("END:VCALENDAR");
    return lines.join("\r\n");
  }

  function downloadIcs() {
    const content = generateIcsContent();
    if (!content) return;

    const blob = new Blob([content], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kidcal-reminders.ics";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast("Downloaded kidcal-reminders.ics");
  }

  // Event listeners
  btnFind.addEventListener("click", () => { handleFind(); });
  btnSample.addEventListener("click", () => { handleSample(); });
  typeFilter.addEventListener("change", () => renderEvents());
  timeFilter.addEventListener("change", () => renderEvents());
  radiusFilter.addEventListener("change", () => renderEvents());
  btnClearReminders.addEventListener("click", () => clearReminders());
  btnDownloadIcs.addEventListener("click", () => downloadIcs());

  cityInput.addEventListener("keyup", (e) => {
    if (e.key === "Enter") handleFind();
  });

  // Initial render
  handleSample();
  renderReminders();
  fetchSheetData();
  fetchExternalEvents(); // safe even if extra-events.json doesn't exist
</script>
</body>
</html>
















